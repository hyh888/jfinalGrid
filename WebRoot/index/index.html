<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Avalonjs学习程序</title>
<script src="/jfinalGrid/js/jquery-1.4.4.min.js" type="text/javascript" ></script>
<!--  script src="/jfinalGrid/js/index.js" type="text/javascript" ></script> -->
<script src="/jfinalGrid/js/avalon.modern.js" type="text/javascript" ></script>
</head>
<body>
<!-- HEADER -->
<div class="head">
    <h1 class="ui header">
       <div class="sub header">走进Jfinal和Avalon 的世界</div>
    </h1>
</div>
<!-- Blog正文 -->
<div class="ui attached bottom segment" ms-controller="items" id="items">
    <div class="ui stacked segment blog">
        <div class="blog-body">
       <h3>ms-repeat实现json输出</h3> 
        <table  width="1000px" cellpadding="0" cellspacing="0" > 
        <tr>
        <th>序号</th>
        <th>id</th>
        <th >idedit</th>
        <th>客户名称</th>
        <th>订单日期</th>    
        <th>id相乘</th>      
        <th colspan="2">删除</th>
      <th>行状态</th>              
        </tr>
            <tr  ms-repeat-el="items"> 
                <td> {{$index+1}}</td> 
                <td>{{el.id}}</td> 
                <td width="60px"><input ms-duplex-number="el.id" /></td> 
                <td><input ms-duplex="el.CustName" /></td>
                <td width="100px">
                <input ms-duplex="el.OrdDate" ms-on-blur="judLast($index,$last)" />                
                </td>
                <td>{{el.id*el.id}}</td>
                <td>
                <input id="del-{{$index}}" status="{{el.myStatus}}"  ms-on-click="changeToDel($index,el.id)" type="checkbox"> 
                </td>
                <td width="30px"><button id="delButton" type="button" ms-on-click="delRecord($index,el.id)">delete</button>
                </td> 
                <td>{{el.myStatus}}</td>
            </tr> 
        </table> 
<button id="hyhButton" type="button" ms-on-click="saveRecord($event,this)">Save</button>
<button id="downexcelButton" type="button" ms-on-click="createExcel()">downloadExcel</button>
<button id="upexcelButton" type="button" ms-on-click="uploadExcel()">uploadExcel</button> 
		 
        
        <div class="ui divider"></div>

    </div>
</div>
<style type="text/css">
td{
 border:thin solid ;
 padding-right: 2px;
 border-color:white white silver silver;
 }
 th{
 border:thin solid ;
 color: Wheat ;
 font-family: Microsoft YaHei;
 background: Purple ;
 border-color:silver silver white white;
 }
 table{
 border:thin solid blueviolet;
 }
 td input{
 border:none;
 width:100%;
 }
 </style> 
<script>
	var model = avalon.define("items", function(vm){
	    vm.items = {};
	});
    uploadExcel=function(){
			    	$.getJSON('/jfinalGrid/item/uploadExcel'),function(data) {
					    	alert(data);
					    	items = data.items; 
					    	items.push({});
				    	}; 
    			};

    	createExcel=function(){
				    	$.getJSON('/jfinalGrid/item/createExcel'),function(data) {
							    	alert(data);
						    	}; 
    				} ;

    	delRecord=function(myIndex,myId){
    				model.items.splice(myIndex,1);
			    	alert(myId);
			    	if(myId!=undefined){
			    		$.getJSON('/jfinalGrid/item/delete/'+myId),function(data) {
							    	myStr=data;
							    	alert(myStr);
						    	};
			    		};
			    	};
    	changeStatus=function(myIndex,myId){
					    		model.items[myIndex]["myStatus"]="E";
					    	};
    	changeToDel=function(myIndex,myId){
    							model.items[myIndex]["myStatus"]="D";
			    			}; 
    	
    	judLast=function(myIndex,myLast){
			    		if (true==myLast){
			    				model.items.push({});
    						};
			    		}; 

    	judChange=function(myIndex,e){
					    	e.item["myStatus"]="U";
					    	console.log(myIndex); 
					    	console.log("change", e.item["id"]); 
				    	}; 

    	saveRecord=function($event,myThis){
				    	var resultItems=new Array();
				    	var itemCount=items.length;
				    	var myArrayNum=0;
				    	for(var i=0;i<itemCount-1;i++) {
						    	if (model.items[i]["myStatus"]!=undefined){
									    	resultItems[myArrayNum]=new Array();
									    	resultItems[myArrayNum]=model.items[i];
									    	myArrayNum++;
								    	};
					    	};
				    	var url='/jfinalGrid/item/batchCrud';
				    	$.post(url, {params: JSON.stringify(resultItems) }).success(function(data){
				    				model.items = data.items; 
							    	model.items.push({});
						    	});
				    	}; 	
	$(function(){
	    $.getJSON('/jfinalGrid/item',function(data){
	        model.items = data["blogPage"]["list"];
	        model.items.push({id:0});
	        console.log(model.blog);
	    });
	    
	});
	
</script>

</body>
</html>